<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Timeline â€” CoinGecko + GNews (iOS friendly)</title>
<link rel="preconnect" href="https://api.coingecko.com">
<link rel="preconnect" href="https://gnews.io">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
  :root{
    --h:560px; --ui:#0ea5e9; --bg:#f3f4f6; --card:#fff; --ink:#0f172a; --muted:#6b7280; --line:#cbd5e1;
    --bull-bg:#e9f8ef; --bear-bg:#ffe9ea; --good:#10b981; --bad:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,system-ui,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 14px;background:#ffffffdd;border-bottom:1px solid #e5e7eb;backdrop-filter:blur(6px)}
  .left,.right{display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}
  .pill{padding:7px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .pill.active{background:var(--ui);border-color:var(--ui);color:#fff}
  .search input{width:260px;padding:10px 12px;border:1px solid #d1d5db;border-radius:12px}
  .btn{padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--ui);border-color:var(--ui);color:#fff}
  .chip{padding:8px 10px;border:1px solid #d1d5db;border-radius:12px;background:#fff;cursor:pointer}
  .grid{display:grid;grid-template-columns:360px 1fr 240px;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 8px rgba(0,0,0,.05)}
  .inner{padding:16px}
  .kpi{display:flex;justify-content:space-between;padding:6px 0}
  .muted{color:var(--muted);font-size:12px}.good{color:var(--good)}.bad{color:var(--bad)}
  .summary{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:12px;padding:10px;font-size:13px;color:#374151}
  /* timeline */
  .tl{position:relative;overflow:hidden;height:var(--h)}
  .split{position:absolute;inset:0;display:grid;grid-template-rows:1fr 1fr}
  .up{background:var(--bull-bg)} .down{background:var(--bear-bg)}
  .mid{position:absolute;left:0;right:0;height:2px;background:var(--line)}
  .sent{position:absolute;right:12px;text-align:center}
  .sent .v{font-size:34px;font-weight:800}
  .sent.b{top:10px}.sent.r{bottom:10px}.sent.b .v{color:var(--good)}.sent.r .v{color:var(--bad)}
  .layer{position:absolute;inset:0;pointer-events:none}
  .col{position:absolute;top:0;bottom:0;transform:translateX(-50%)} .vline{position:absolute;width:2px;background:var(--line)}
  .date{position:absolute;transform:translate(-50%,-50%);top:0;left:50%;padding:3px 6px;border:1px solid #e5e7eb;background:#fff;border-radius:6px;font-size:10px;color:#374151}
  .bubble{position:absolute;left:50%;transform:translate(-50%,0);border-radius:999px;display:grid;place-items:center;color:#fff;box-shadow:0 10px 22px rgba(0,0,0,.18);pointer-events:auto;overflow:hidden;transition:transform .2s ease}
  .bubble:hover{transform:translate(-50%,0) scale(1.06)}
  .bull{background:linear-gradient(145deg,#16a34a,#065f46)} .bear{background:linear-gradient(145deg,#ef4444,#991b1b)} .neu{background:linear-gradient(145deg,#9ca3af,#6b7280)}
  .bubble img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.25;filter:grayscale(15%)} .btxt{position:relative;font-size:11px;font-weight:800;text-shadow:0 1px 3px rgba(0,0,0,.35)}
  .top3{outline:3px solid gold;outline-offset:2px}
  .tip{position:absolute;z-index:30;background:#fff;color:#111827;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;box-shadow:0 8px 24px rgba(0,0,0,.15);width:280px;font-size:12px;display:none}
  .tip .src{color:#64748b;font-size:11px;margin-top:4px}
  /* loaders */
  .topbar{position:absolute;left:0;right:0;bottom:-2px;height:3px;background:#e5e7eb}.prog{width:0%;height:100%;background:linear-gradient(90deg,var(--ui),#3b82f6);transition:width .25s ease}
  .overlay{position:fixed;inset:0;background:#ffffffd9;backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;z-index:50}
  .bar{width:360px;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}.bar>div{width:0%;height:100%;background:linear-gradient(90deg,var(--ui),#3b82f6);transition:width .25s ease}
  @media(prefers-color-scheme:dark){
    body{background:#0b0e13;color:#e5e7eb} header{background:#0f131add;border-bottom-color:#1f2937}
    .search input,.btn,.pill,.chip{background:#0f131a;border-color:#273244;color:#e5e7eb}
    .card{background:#0f131a;border-color:#1f2937}.summary{background:#0b0e13;border-color:#1f2937;color:#cbd5e1}
    .mid,.vline{background:#334155}.date{background:#0f131a;border-color:#273244;color:#cbd5e1}
    .up{background:#0c2016}.down{background:#2a0d12}.tip{background:#0f131a;border-color:#273244;color:#e5e7eb}
    .overlay{background:#0b0e13cc}
  }
</style>
</head>
<body>
<header>
  <div class="left">
    <div class="brand">ðŸ“Š Crypto Timeline</div>
    <div class="search">
      <input id="coinInput" placeholder="Search coin (e.g., bitcoin, ethereum, solana)"/>
      <button class="btn primary" id="loadBtn">Load</button>
      <button class="chip" id="apiBtn">News API Key</button>
    </div>
    <div id="range">
      <button class="pill active" data-d="7">1W</button>
      <button class="pill" data-d="30">1M</button>
      <button class="pill" data-d="90">3M</button>
    </div>
  </div>
  <div class="right" style="position:relative">
    <div class="topbar"><div id="topProg" class="prog"></div></div>
  </div>
</header>

<div class="grid">
  <div class="card"><div class="inner">
    <div id="coinTitle" style="font-weight:800;font-size:18px;margin-bottom:6px">Bitcoin (BTC)</div>
    <div class="muted" style="margin-bottom:10px">Price: CoinGecko â€¢ News: GNews</div>
    <div id="stats">Loadingâ€¦</div>
    <div style="height:8px"></div>
    <div class="summary" id="summaryBox">Summary will appear after data loadsâ€¦</div>
    <div style="height:8px"></div>
    <div class="summary" id="top3Box">Top 3 impactful headlines will appear hereâ€¦</div>
  </div></div>

  <div class="card tl" id="timeline">
    <div class="split"><div class="up"></div><div class="down"></div></div>
    <canvas id="chart"></canvas>
    <div class="mid" id="centerLine"></div>
    <div class="layer" id="bubbleLayer"></div>
    <div class="sent b"><div class="v" id="bullPct">0%</div><div class="muted">Bullish</div></div>
    <div class="sent r"><div class="v" id="bearPct">0%</div><div class="muted">Bearish</div></div>
    <div class="tip" id="tooltip"></div>
  </div>

  <div class="card"><div class="inner">
    <div style="font-weight:700">Tips</div>
    <div class="muted" style="margin-top:6px">Click a bubble to open the article. Hover shows source & date.</div>
    <div class="muted" style="margin-top:10px" id="pageInfo">â€”</div>
  </div></div>
</div>

<!-- overlay loader -->
<div class="overlay" id="overlay">
  <div class="bar"><div id="ovFill"></div></div>
  <div class="muted" id="ovTxt">Loadingâ€¦</div>
</div>

<script>
(() => {
  // Elements
  const coinInput = document.getElementById('coinInput');
  const loadBtn = document.getElementById('loadBtn');
  const apiBtn = document.getElementById('apiBtn');
  const topProg = document.getElementById('topProg');
  const overlay = document.getElementById('overlay');
  const ovFill = document.getElementById('ovFill');
  const ovTxt = document.getElementById('ovTxt');

  const statsBox = document.getElementById('stats');
  const summaryBox = document.getElementById('summaryBox');
  const top3Box = document.getElementById('top3Box');
  const coinTitle = document.getElementById('coinTitle');
  const bubbleLayer = document.getElementById('bubbleLayer');
  const centerLine = document.getElementById('centerLine');
  const bullPct = document.getElementById('bullPct');
  const bearPct = document.getElementById('bearPct');
  const pageInfo = document.getElementById('pageInfo');
  const tooltip = document.getElementById('tooltip');

  let chart, chartData=[], coinList=null, coinId='bitcoin', coinSymbol='BTC', coinName='Bitcoin', days=30;
  const timeFmt = ms => new Date(ms).toLocaleString();

  // UI helpers
  const setTop = p => topProg.style.width = p + '%';
  const showOverlay = (t='Loadingâ€¦') => { overlay.style.display='flex'; ovTxt.textContent=t; ovFill.style.width='0%'; };
  const stepOverlay = (p,t) => { ovFill.style.width=p+'%'; if(t) ovTxt.textContent=t; };
  const hideOverlay = () => overlay.style.display='none';
  const fmt = v => v==null?'â€”': v>1e12?(v/1e12).toFixed(2)+'T': v>1e9?(v/1e9).toFixed(2)+'B': v>1e6?(v/1e6).toFixed(2)+'M': (Math.round(v*100)/100).toLocaleString();

  // Persist API key
  const getKey = () => localStorage.getItem('gnews_token') || '';
  const setKey = k => localStorage.setItem('gnews_token', k.trim());
  apiBtn.addEventListener('click', () => {
    const current = getKey();
    const k = prompt('Paste your GNews API token (stored locally):', current || '');
    if(k!=null){ setKey(k); alert('Saved. Search a coin to load fresh news.'); }
  });

  // Coin list (for search)
  async function ensureCoinList(){
    if(coinList) return coinList;
    const r = await fetch('https://api.coingecko.com/api/v3/coins/list?include_platform=false');
    coinList = await r.json(); return coinList;
  }
  function findCoin(q){
    if(!coinList) return null;
    const exact = coinList.find(c=>c.id===q || c.symbol===q || c.name.toLowerCase()===q);
    if(exact) return exact;
    return coinList.find(c=>c.name.toLowerCase().includes(q) || c.symbol===q);
  }

  // Chart load (CoinGecko)
  async function loadPrices(){
    setTop(10);
    const url=`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${days}`;
    const r=await fetch(url); const data=await r.json();
    const prices=(data.prices||[]); chartData = prices.map(p=>({t:p[0], y:p[1]}));
    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx,{
      type:'line',
      data:{datasets:[{data:chartData,parsing:{xAxisKey:'t',yAxisKey:'y'},borderColor:'#0f172a',borderWidth:2,pointRadius:0,tension:.25}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{x:{type:'time',time:{unit:days<=7?'day':'week'},grid:{display:false}},y:{grid:{color:'rgba(148,163,184,.25)'}}},plugins:{legend:{display:false},tooltip:{enabled:false}}}
    });
    const first=prices[0]?.[1], last=prices.at(-1)?.[1], ch=((last-first)/first)*100;
    statsBox.innerHTML = `
      <div class="kpi"><span>Price</span><strong>$${fmt(last)}</strong></div>
      <div class="kpi"><span>Change (${days===7?'1W':days===30?'1M':'3M'})</span><strong class="${ch>=0?'good':'bad'}">${(ch||0).toFixed(2)}%</strong></div>
    `;
    setTop(35);
    return {first,last,ch};
  }

  // News (GNews)
  function senti(title){
    const t=title.toLowerCase();
    const pos=['surge','record','approve','partnership','adopt','rally','up','bull','funding','launch','growth','wins','support','integration','buy','adds','builds','expands'];
    const neg=['hack','ban','fall','plunge','lawsuit','probe','halt','outage','exploit','scam','bear','crash','dump','delay','bug','vulnerability','charges'];
    let s=0; pos.forEach(k=>t.includes(k)&&(s+=1)); neg.forEach(k=>t.includes(k)&&(s-=1)); return s;
  }
  function relScore(item, fromMs){
    const age = (Date.now()-item.publishedAtMs)/86400000;
    const rec = Math.max(0, 1 - age/(days||30));
    const se  = Math.min(1, Math.abs(item.sent)/3);
    const src = /coindesk|cointelegraph|decrypt|reuters|bloomberg|wsj|ft\.com/i.test(item.domain)?1:0.7;
    return 0.5*rec + 0.35*se + 0.15*src;
  }
  function consensus(item){
    const se=Math.min(1, Math.abs(item.sent)/3);
    const src=/coindesk|cointelegraph|decrypt|reuters|bloomberg|ft\.com/i.test(item.domain)?0.8:0.5;
    return Math.max(0.2, Math.min(1, 0.45*se + 0.55*src));
  }

  async function loadNews(){
    const token = getKey();
    if(!token){
      // Small demo so UI renders without key
      const now=Date.now();
      return [
        {title:`${coinName} adoption rises with new integration`, url:'https://www.coindesk.com/', publishedAtMs:now-3*86400000, domain:'coindesk.com'},
        {title:`Major exchange outage impacts ${coinSymbol}`, url:'https://cointelegraph.com/', publishedAtMs:now-6*86400000, domain:'cointelegraph.com'},
        {title:`Institutional inflows support ${coinName} rally`, url:'https://www.reuters.com/', publishedAtMs:now-9*86400000, domain:'reuters.com'}
      ].map(x=>({...x, sent:senti(x.title)}));
    }
    setTop(55);
    const toISO = new Date().toISOString().slice(0,19)+'Z';
    const fromISO = new Date(Date.now()-days*86400000).toISOString().slice(0,19)+'Z';
    const q = encodeURIComponent(`${coinName} OR ${coinSymbol} cryptocurrency`);
    const url = `https://gnews.io/api/v4/search?q=${q}&lang=en&country=us&from=${fromISO}&to=${toISO}&in=title&max=50&sortby=publishedAt&token=${token}`;
    const r=await fetch(url);
    if(!r.ok){ throw new Error('GNews error '+r.status); }
    const data=await r.json();
    const items=(data.articles||[]).map(a=>{
      const domain = a.source?.name ? a.source.name.toLowerCase().replace(/^www\./,'') : (a.url? new URL(a.url).hostname.replace(/^www\./,'') : '');
      return {title:a.title,url:a.url,publishedAtMs:Date.parse(a.publishedAt),domain, image:a.image, sent:senti(a.title)};
    });
    setTop(75);
    return items;
  }

  // Render bubbles
  function pxFor(ms){ return chart.scales.x.getPixelForValue(ms); }
  function renderBubbles(items, kpi){
    bubbleLayer.innerHTML='';
    // rank
    const fromMs = Date.now()-days*86400000;
    items.forEach(it=> it.rel = relScore(it, fromMs));
    items.forEach(it=> it.cons = consensus(it));
    items.sort((a,b)=> b.rel - a.rel);
    const list = items.slice(0,20).sort((a,b)=> a.publishedAtMs - b.publishedAtMs);

    // sentiment % + center line shift
    const bulls = list.filter(n=>n.sent>0).length;
    const bears = list.filter(n=>n.sent<0).length;
    const total = Math.max(1, bulls + bears);
    bullPct.textContent = Math.round(bulls/total*100)+'%';
    bearPct.textContent = Math.round(bears/total*100)+'%';
    const shift = ((bears-bulls)/total)*60;
    const h = document.getElementById('timeline').clientHeight;
    const cy = h/2 + shift;
    centerLine.style.top = cy+'px';

    // top 3 box
    const t3 = [...list].sort((a,b)=> b.rel - a.rel).slice(0,3);
    top3Box.innerHTML = '<strong>Top 3 impactful headlines</strong><ol style="margin:6px 0 0 18px;padding:0">'
      + t3.map(n=>`<li><a href="${n.url}" target="_blank" rel="noopener">${n.title}</a> <span class="muted">(${n.domain})</span></li>`).join('')
      + '</ol>';

    // summary
    const ch = kpi.ch||0;
    summaryBox.innerHTML = `
      <div><strong>${coinName}</strong> moved <strong class="${ch>=0?'good':'bad'}">${(ch||0).toFixed(2)}%</strong> over the last <strong>${days===7?'1W':days===30?'1M':'3M'}</strong>.</div>
      <div>News mix: <strong>${bulls}</strong> bullish / <strong>${bears}</strong> bearish (max 20 shown).</div>
      <div class="muted">Size=relevance â€¢ Distance=consensus â€¢ Above/Below=bull/bear.</div>
    `;

    // draw
    const tip = document.getElementById('tooltip');
    list.forEach(n=>{
      const x = pxFor(n.publishedAtMs);
      const dist = 30 + n.cons*170;
      const y = n.sent>0 ? cy - dist : n.sent<0 ? cy + dist : cy;
      const size = 22 + Math.min(1, Math.max(0, n.rel))*48;

      const col = document.createElement('div'); col.className='col'; col.style.left = x+'px';
      const v = document.createElement('div'); v.className='vline'; v.style.top=Math.min(cy,y)+'px'; v.style.height=Math.abs(cy-y)+'px'; v.style.left='50%'; v.style.transform='translateX(-50%)';
      const tag = document.createElement('div'); tag.className='date'; tag.style.top=cy+'px'; tag.textContent=new Date(n.publishedAtMs).toLocaleDateString();

      const b = document.createElement('div'); b.className='bubble '+(n.sent>0?'bull':n.sent<0?'bear':'neu')+(t3.includes(n)?' top3':'');
      b.style.width=size+'px'; b.style.height=size+'px'; b.style.top=(y - size/2)+'px';
      b.addEventListener('click', ()=> window.open(n.url,'_blank','noopener'));
      const img = document.createElement('img'); img.src = n.image || `https://www.google.com/s2/favicons?domain=${encodeURIComponent(n.domain)}&sz=64`; img.alt=''; b.appendChild(img);
      const t = document.createElement('div'); t.className='btxt'; t.textContent = Math.round(50 + n.rel*50); b.appendChild(t);

      b.addEventListener('mouseenter', e=>{ tip.style.display='block'; tip.style.left=(e.pageX+12)+'px'; tip.style.top=(e.pageY-10)+'px'; tip.innerHTML=`<strong>${n.title}</strong><div class="src">${n.domain} â€¢ ${timeFmt(n.publishedAtMs)}</div>`; });
      b.addEventListener('mouseleave', ()=> tip.style.display='none');

      col.appendChild(v); col.appendChild(tag); col.appendChild(b); bubbleLayer.appendChild(col);
    });

    pageInfo.textContent = `Showing ${list.length} items`;
  }

  // Range picker
  document.getElementById('range').addEventListener('click', async e=>{
    const btn=e.target.closest('button[data-d]'); if(!btn) return;
    [...document.querySelectorAll('#range .pill')].forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    days=parseInt(btn.dataset.d,10); showOverlay('Loading rangeâ€¦'); stepOverlay(15);
    const kpi=await loadPrices(); stepOverlay(55,'Loading newsâ€¦');
    const news=await loadNews(); stepOverlay(85,'Renderingâ€¦'); renderBubbles(news,kpi); stepOverlay(100,'Done'); setTimeout(hideOverlay,350);
  });

  // Search
  loadBtn.addEventListener('click', async ()=>{
    const q=(coinInput.value||'').trim().toLowerCase(); if(!q) return;
    showOverlay('Searching coinâ€¦'); stepOverlay(10);
    await ensureCoinList(); const match=findCoin(q);
    if(!match){ stepOverlay(100,'Not found'); setTimeout(hideOverlay,400); alert('Coin not found. Try "bitcoin", "ethereum", "solana".'); return; }
    coinId=match.id; coinSymbol=match.symbol.toUpperCase(); coinName=match.name;
    coinTitle.textContent=`${coinName} (${coinSymbol})`;
    stepOverlay(40,'Loading priceâ€¦'); const kpi=await loadPrices();
    stepOverlay(70,'Loading newsâ€¦'); const news=await loadNews();
    stepOverlay(90,'Renderingâ€¦'); renderBubbles(news,kpi);
    stepOverlay(100,'Done'); setTimeout(hideOverlay,400);
  });

  // initial BTC load
  (async () => {
    setTop(2);
    const kpi = await loadPrices();
    const news = await loadNews();
    renderBubbles(news, kpi);
    setTop(100);
  })();
})();
</script>
</body>
</html>
